<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add SSH Connection</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body style="margin: 0; padding: 16px; background: #f5f5f5;">
  <div style="background: white; border-radius: 8px; padding: 0; height: calc(100vh - 32px); display: flex; flex-direction: column;">
    <div class="modal-header">
      <h3>Add SSH Connection</h3>
    </div>
    <div class="modal-body" style="flex: 1; overflow-y: auto;">
      <form id="add-connection-form">
        <!-- Advanced options for jump-host template -->
        <div id="jump-host-options" class="detail-section" style="display: none;">
          <h4>Jump Host Settings</h4>
          <div class="detail-grid">
            <div class="form-group">
              <label for="jump-host">Jump Host</label>
              <input type="text" id="jump-host" name="jumpHost" placeholder="bastion.example.com">
            </div>
          </div>
        </div>

        <!-- Basic Connection Details Section -->
        <div class="detail-section">
          <h4>Basic Connection Details</h4>
          
          <!-- Icon Selector -->
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="connection-icon">Connection Icon</label>
            <div class="icon-selector">
              <div class="icon-options">
                <input type="radio" id="icon-default" name="icon" value="üíª" checked>
                <label for="icon-default" class="icon-option">üíª</label>
                
                <input type="radio" id="icon-work" name="icon" value="üíº">
                <label for="icon-work" class="icon-option">üíº</label>
                
                <input type="radio" id="icon-personal" name="icon" value="üè†">
                <label for="icon-personal" class="icon-option">üè†</label>
                
                <input type="radio" id="icon-projects" name="icon" value="üöÄ">
                <label for="icon-projects" class="icon-option">üöÄ</label>
                
                <input type="radio" id="icon-clients" name="icon" value="üë•">
                <label for="icon-clients" class="icon-option">üë•</label>
                
                <input type="radio" id="icon-servers" name="icon" value="üñ•Ô∏è">
                <label for="icon-servers" class="icon-option">üñ•Ô∏è</label>
                
                <input type="radio" id="icon-testing" name="icon" value="üß™">
                <label for="icon-testing" class="icon-option">üß™</label>
                
                <input type="radio" id="icon-production" name="icon" value="üè≠">
                <label for="icon-production" class="icon-option">üè≠</label>
                
                <input type="radio" id="icon-development" name="icon" value="üîß">
                <label for="icon-development" class="icon-option">üîß</label>
              </div>
            </div>
          </div>
          
          <div class="detail-grid">
            <div class="form-group">
              <label for="connection-name">Connection Name</label>
              <input type="text" id="connection-name" name="name" required placeholder="e.g., Production Server">
            </div>
            <div class="form-group">
              <label for="group">Group</label>
              <select id="group" name="group">
                <option value="personal">Personal</option>
                <option value="work">Work</option>
                <option value="projects">Projects</option>
              </select>
            </div>
            <div class="form-group">
              <label for="host">Hostname</label>
              <input type="text" id="host" name="host" required placeholder="e.g., 192.168.1.100 or server.example.com">
            </div>
            <div class="form-group">
              <label for="user">Username</label>
              <input type="text" id="user" name="user" placeholder="e.g., ubuntu, admin (leave empty to use current user)">
            </div>
            <div class="form-group">
              <label for="port">Port</label>
              <input type="number" id="port" name="port" value="22" min="1" max="65535">
            </div>
            <div class="form-group">
              <label for="key-file">SSH Key File</label>
              <input type="text" id="key-file" name="keyFile" placeholder="~/.ssh/id_ed25519">
            </div>
          </div>
        </div>

        <!-- Template Section -->
        <div class="detail-section">
          <h4>Configuration Template</h4>
          <div class="detail-grid">
            <div class="form-group">
              <label for="template">Template</label>
              <select id="template" name="template" onchange="handleTemplateChange()">
                <option value="basic-server">Basic Server</option>
                <option value="developer">Developer Workstation</option>
                <option value="aws-ec2">AWS EC2 Instance</option>
                <option value="jump-host">Jump Host</option>
                <option value="development">Development Server</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Connection Settings -->
        <div class="detail-section">
          <h4>Connection Settings</h4>
          <div class="detail-grid">
            <div class="form-group">
              <label for="connect-timeout">Connect Timeout (seconds)</label>
              <input type="number" id="connect-timeout" name="connectTimeout" min="1" max="300" value="10" title="How long to wait when establishing connection">
            </div>
            <div class="form-group">
              <label for="server-alive-interval">Keep-Alive Interval (seconds)</label>
              <input type="number" id="server-alive-interval" name="serverAliveInterval" min="0" max="3600" value="60" title="Send keep-alive packets every N seconds (0 = disabled)">
            </div>
            <div class="form-group">
              <label for="server-alive-count">Keep-Alive Max Count</label>
              <input type="number" id="server-alive-count" name="serverAliveCountMax" min="1" max="10" value="3" title="Disconnect after N failed keep-alive attempts">
            </div>
            <div class="form-group">
              <label for="compression">Compression</label>
              <select id="compression" name="compression" title="Enable data compression (recommended for slow connections)">
                <option value="yes" selected>Yes</option>
                <option value="no">No</option>
              </select>
            </div>
            <div class="form-group">
              <label for="strict-host-checking">Host Key Checking</label>
              <select id="strict-host-checking" name="strictHostKeyChecking" title="How to handle unknown host keys">
                <option value="ask" selected>Ask (Prompt user)</option>
                <option value="yes">Yes (Strict)</option>
                <option value="no">No (Insecure)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Developer Features -->
        <div class="detail-section">
          <h4>Developer Features</h4>
          <div class="detail-grid">
            <div class="form-group">
              <label for="control-master">Connection Multiplexing</label>
              <select id="control-master" name="controlMaster" title="Reuse SSH connections for faster subsequent connections">
                <option value="auto" selected>Auto</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
            <div class="form-group">
              <label for="control-persist">Persist Duration</label>
              <input type="text" id="control-persist" name="controlPersist" value="10m" placeholder="10m" title="How long to keep master connection alive">
            </div>
            <div class="form-group">
              <label for="forward-x11">X11 Forwarding (GUI Apps)</label>
              <select id="forward-x11" name="forwardX11" title="Enable GUI applications over SSH">
                <option value="no" selected>No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
            <div class="form-group">
              <label for="forward-agent">SSH Agent Forwarding</label>
              <select id="forward-agent" name="forwardAgent" title="Forward SSH agent for key-based authentication">
                <option value="no" selected>No (Secure)</option>
                <option value="yes">Yes (Less Secure)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="dynamic-forward">SOCKS Proxy Port</label>
              <input type="number" id="dynamic-forward" name="dynamicForward" min="1" max="65535" placeholder="e.g., 1080" title="Dynamic port forwarding for SOCKS proxy">
            </div>
          </div>
          
          <!-- Port Forwarding Section -->
          <h5>Local Port Forwards</h5>
          <div class="form-group">
            <div id="local-forwards-container">
              <div class="port-forward-row">
                <input type="number" placeholder="Local Port" name="localPort[]" min="1" max="65535">
                <input type="text" placeholder="Remote Host" name="remoteHost[]" value="localhost">
                <input type="number" placeholder="Remote Port" name="remotePort[]" min="1" max="65535">
                <button type="button" class="btn-small btn-remove" onclick="removeForwardRow(this)">√ó</button>
              </div>
            </div>
            <button type="button" id="add-local-forward" class="btn-small btn-secondary">+ Add Local Forward</button>
          </div>
        </div>

        <!-- Actions -->
        <div class="detail-section">
          <div class="detail-actions">
            <button type="submit" class="btn btn-primary">‚ûï Add Connection</button>
            <button type="button" class="btn btn-secondary" onclick="window.close()">‚ùå Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Handle template changes
    function handleTemplateChange() {
      const template = document.getElementById('template').value;
      const jumpHostOptions = document.getElementById('jump-host-options');
      
      if (template === 'jump-host') {
        jumpHostOptions.style.display = 'block';
      } else {
        jumpHostOptions.style.display = 'none';
      }
    }

    // Handle adding/removing port forwards
    document.getElementById('add-local-forward').addEventListener('click', () => {
      const container = document.getElementById('local-forwards-container');
      const newRow = document.createElement('div');
      newRow.className = 'port-forward-row';
      newRow.innerHTML = `
        <input type="number" placeholder="Local Port" name="localPort[]" min="1" max="65535">
        <input type="text" placeholder="Remote Host" name="remoteHost[]" value="localhost">
        <input type="number" placeholder="Remote Port" name="remotePort[]" min="1" max="65535">
        <button type="button" class="btn-small btn-remove" onclick="removeForwardRow(this)">√ó</button>
      `;
      container.appendChild(newRow);
    });

    function removeForwardRow(button) {
      button.parentElement.remove();
    }

    // Handle form submission
    document.getElementById('add-connection-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      
      const options = {
        name: formData.get('name'),
        host: formData.get('host'),
        user: formData.get('user'),
        port: parseInt(formData.get('port')) || 22,
        group: formData.get('group'),
        icon: formData.get('icon') || 'üíª',
        keyFile: formData.get('keyFile') || '~/.ssh/id_ed25519',
        template: formData.get('template'),
        jumpHost: formData.get('jumpHost'),
        connectTimeout: parseInt(formData.get('connectTimeout')) || 10,
        serverAliveInterval: parseInt(formData.get('serverAliveInterval')) || 60,
        serverAliveCountMax: parseInt(formData.get('serverAliveCountMax')) || 3,
        compression: formData.get('compression'),
        strictHostKeyChecking: formData.get('strictHostKeyChecking'),
        controlMaster: formData.get('controlMaster'),
        controlPersist: formData.get('controlPersist'),
        forwardX11: formData.get('forwardX11'),
        forwardAgent: formData.get('forwardAgent'),
        dynamicForward: formData.get('dynamicForward') ? parseInt(formData.get('dynamicForward')) : null
      };

      // Collect port forwards
      const localPorts = formData.getAll('localPort[]');
      const remoteHosts = formData.getAll('remoteHost[]');
      const remotePorts = formData.getAll('remotePort[]');
      const localForwards = [];
      
      for (let i = 0; i < localPorts.length; i++) {
        if (localPorts[i] && remotePorts[i]) {
          localForwards.push({
            localPort: parseInt(localPorts[i]),
            remoteHost: remoteHosts[i] || 'localhost',
            remotePort: parseInt(remotePorts[i])
          });
        }
      }
      
      if (localForwards.length > 0) {
        options.localForwards = localForwards;
      }

      try {
        const result = await window.electronAPI.ssh.addConnection(options);
        if (result.success) {
          // Refresh the main window before closing
          await window.electronAPI.window.refreshMain();
          window.close();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });

    // Initialize template change handler
    handleTemplateChange();
  </script>
</body>
</html>